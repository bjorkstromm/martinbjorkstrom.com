
<!DOCTYPE html>
<!--
	Phantom by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html lang="en">

	<head>
		<title>Martin Bj&#xF6;rkstr&#xF6;m - Testing protected Azure Functions running in a container on your local machine</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />		
        <link href="/assets/css/highlight.css" rel="stylesheet">
		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="/assets/css/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
        <link href="/assets/css/override.css" rel="stylesheet" />

		<meta name="description" content="Driving Digital Transformation on Serverless Containers..." />
		<link type="application/rss+xml" rel="alternate" title="Martin Bj&#xF6;rkstr&#xF6;m" href="/feed.rss" />
				<link type="application/atom+xml" rel="alternate" title="Martin Bj&#xF6;rkstr&#xF6;m" href="/feed.atom" />
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" href="/favicon.ico" type="image/x-icon">

		<meta name="application-name" content="Martin Bj&#xF6;rkstr&#xF6;m" />
		<meta name="msapplication-tooltip" content="Martin Bj&#xF6;rkstr&#xF6;m" />
		<meta name="msapplication-starturl" content="/" />

		<meta property="og:title" content="Martin Bj&#xF6;rkstr&#xF6;m - Testing protected Azure Functions running in a container on your local machine" /> 
		<meta property="og:type" content="website" />
		<meta property="og:url" content="http://martinbjorkstrom.com/posts/2020-02-12-testing-protected-azure-functions" />
		<!-- TODO: More social graph meta tags -->

        <script src="/assets/js/highlight.pack.js"></script>   
		
        

		
	</head>

	<body>
		<!-- Wrapper -->
		<div id="wrapper">

			<!-- Header -->
			<header id="header">
				<div class="inner">

					<!-- Logo -->
					<a href="/" class="logo">
						<span class="title">Martin Bj&#xF6;rkstr&#xF6;m</span>
					</a>

					<!-- Nav -->
					<nav>
						<ul>
							<li><a href="#menu">Menu</a></li>
						</ul>
					</nav>

				</div>
			</header>

			<!-- Menu -->
			<nav id="menu">
				<h2>Menu</h2>
				<ul>
					        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>

				</ul>
			</nav>

			<!-- Main -->
			<div id="main">
				<div class="inner">

    
<header>
    <h1>Testing protected Azure Functions running in a container on your local machine</h1>
            <p><em>Published on Wednesday, 12 February 2020</em></p>
            <ul class="actions small">
                    <li><a role="button" href="/tags/azure" class="button small">Azure</a></li>
                    <li><a role="button" href="/tags/azure-functions" class="button small">Azure Functions</a></li>
        </ul>     
</header>

					
					<div id="content">
						

<p>Recently I had to create an Azure Function using a custom container. The reason was a client of mine did some really cool things using Puppeteer, and now they wanted to run this in an Azure Function. So, I went to <a href="https://docs.microsoft.com">docs.microsoft.com</a> and found a great <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-function-linux-custom-image?tabs=portal%2Cbash&amp;pivots=programming-language-csharp">tutorial</a> on how to create a function on Linux using a custom container. However, a little bit into the tutorial, in the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-function-linux-custom-image?tabs=portal%2Cbash&amp;pivots=programming-language-csharp">build the container image and test locally</a> section, I noticed something very annoying, namely this:</p>
<blockquote class="blockquote">
<p>Once the image is running in a local container, open a browser to <a href="http://localhost:8080,">http://localhost:8080,</a> which should display the placeholder image shown below. The image appears at this point because your function is running in the local container, as it would in Azure, which means that it's protected by an access key as defined in function.json with the &quot;authLevel&quot;: &quot;function&quot; property. The container hasn't yet been published to a function app in Azure, however, so the key isn't yet available. <strong>If you want to test locally, stop docker, change the authorization property to &quot;authLevel&quot;: &quot;anonymous&quot;, rebuild the image, and restart docker. Then reset &quot;authLevel&quot;: &quot;function&quot; in function.json.</strong> For more information, see <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook#authorization-keys">authorization keys</a>.</p>
</blockquote>
<p>Wait, what? Modify code, and rebuild the image? That sounds like a terribly slow and error-prone solution for testing your custom image locally. We will use the same image in Azure, with authorization working, so there must be a better way than modifying code and rebuilding the image. Digging deeper I found out that someone else was also asking about the same thing <a href="https://github.com/Azure/azure-functions-host/issues/4147">here</a>. The issue also contained a solution to my problem, see <a href="https://github.com/Azure/azure-functions-host/issues/4147#issuecomment-477431016">this</a>. The solution is to provide a custom <code>host.json</code> to the container running locally. I found the easiest way to do this was to mount a volume from the host machine containing the custom <code>host.json</code>. So, here's how I did this:</p>
<h2 id="enabling-shared-drives-with-docker-for-windows">1. Enabling Shared Drives with Docker for Windows</h2>
<p>I use Windows as my primary OS, thus using Docker for Windows in order to use Docker. There are lots of guides on how to enable Shared Drives. There's even one over at <a href="https://docs.microsoft.com/en-us/archive/blogs/wael-kdouh/enabling-drive-sharing-with-docker-for-windows">docs.microsoft.com</a>. I however <strong>strongly</strong> disagree with adding the local account into the <code>Administrators</code> group. Instead I created a local account, removed it from the <code>Users</code> group, and only gave the account access to the folder I wanted to share with Docker. In my case the folder I wanted to share with Docker was <code>C:\temp\docker</code>.</p>
<h2 id="create-custom-host.json">2. Create custom host.json</h2>
<p>Next thing to do is to create a file called <code>host.json</code> with the following content:</p>
<pre><code class="language-json">{
  &quot;masterKey&quot;: {
    &quot;name&quot;: &quot;master&quot;,
    &quot;value&quot;: &quot;test&quot;,
    &quot;encrypted&quot;: false
  },
  &quot;functionKeys&quot;: [ ]
}
</code></pre>
<p>The value of the <code>masterKey</code> will be used as function key when testing the function later. I stored this file in folder <code>C:\temp\docker\keys</code>.</p>
<h2 id="testing-the-container-image-locally">3. Testing the container image locally</h2>
<p>In order to test this out, we need to create an Azure Function using a custom container. So, we'll follow the tutorial I linked to in the beginning of this post.</p>
<p>First, we'll create a new Functions project.</p>
<pre><code class="language-powershell">func init LocalFunctionsProject --worker-runtime dotnet --docker
</code></pre>
<p>Then we'll add a function with a HTTP trigger</p>
<pre><code class="language-powershell">func new --name HttpExample --template &quot;HTTP trigger&quot;
</code></pre>
<p>Then we'll build the image</p>
<pre><code class="language-powershell">docker build -t localfunctions:dev .
</code></pre>
<p>And last, we'll run a container</p>
<pre><code class="language-powershell">docker run -v C:\temp\docker\keys:/azure-functions-host/Secrets `
 -e AzureWebJobsSecretStorageType=files `
 -e AzureFunctionsJobHost__Logging__Console__IsEnabled=true `
 -p 8080:80 -it localfunctions:dev
</code></pre>
<p>The <code>-v</code> option will instruct Docker to mount a volume. In the example above it means that the folder <code>C:\temp\docker\keys</code> on the host will be mounted at <code>/azure-functions-host/Secrets</code> inside the container. This is a special folder that the Azure Functions runtime will use when we set the environment variable <code>AzureWebJobsSecretStorageType</code> to <code>files</code>. Remember that our custom <code>host.json</code> we created earlier sits in the <code>C:\temp\docker\keys</code> folder on the host machine.</p>
<p>As a bonus, we'll also enable console logging by setting the environment variable <code>AzureFunctionsJobHost__Logging__Console__IsEnabled</code> to <code>true</code>. This will help us a lot if/when we need to troubleshoot any issues in our container.</p>
<p>When the container is running, we can then test the function using e.g. cURL. First, we'll omit the function key (just to prove a point).</p>
<pre><code class="language-bash">$ curl -s -i http://localhost:8080/api/HttpExample?name=foo
HTTP/1.1 401 Unauthorized
Date: Wed, 12 Feb 2020 21:13:23 GMT
Server: Kestrel
Content-Length: 0
</code></pre>
<p>And we'll get a <code>401 Unauthorized</code>, just like we should. Now, we'll add the function key as request-header (remember the value of the function key was <code>test</code>)</p>
<pre><code class="language-bash">$ curl -s -i -H &quot;x-functions-key:test&quot; http://localhost:8080/api/HttpExample?name=foo
HTTP/1.1 200 OK
Date: Wed, 12 Feb 2020 21:17:05 GMT
Content-Type: text/plain; charset=utf-8
Server: Kestrel
Content-Length: 10

Hello, foo
</code></pre>
<p>And now we'll get a <code>200 OK</code> and a nice greeting from the server. Thanks for reading and hope you found this post useful.</p>



					</div>
				</div>
			</div>

			<!-- Footer -->
			<footer id="footer">
				<div class="inner">
    <section>
        <h2>Feeds</h2>
        <ul class="actions small vertical">
            <li><a href="/feed.rss" class="button small"><i class="fa fa-rss"></i> RSS Feed</a></li>
                        <li><a href="/feed.atom" class="button small"><i class="fa fa-rss"></i> Atom Feed</a></li>
        </ul>
    </section>
    <section>
    </section>
    <ul class="copyright">
        <li>Copyright © 2020</li>
        <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
        <li><a href="https://wyam.io">Generated by Wyam</a></li>
    </ul>
</div>

			</footer>

		</div>
		
		<script type="text/javascript">
    // Google Analytics
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-121782933-1', 'auto');
    ga('send', 'pageview');
</script>

		<!-- Scripts -->
		<script>hljs.initHighlightingOnLoad();</script>
		<script src="/assets/js/jquery.min.js"></script>
		<script src="/assets/js/skel.min.js"></script>
		<script src="/assets/js/util.js"></script>
		<!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
		<script src="/assets/js/main.js"></script>

	</body>

</html>
